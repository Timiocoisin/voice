## 变声器桌面客户端（PyQt6）

一个基于 **PyQt6** 的桌面变声器客户端，采用**前后端分离架构**。客户端负责 UI 展示，后端提供 HTTP API 服务，集成了用户登录/注册、邮箱验证、VIP 会员体系、钻石充值、系统公告展示，以及内置的客服聊天面板（关键词自动回复），适合作为**商业化变声器前端客户端**或桌面应用模板进行二次开发。

---

## 架构说明

本项目采用**前后端分离架构**：

- **后端（`backend/`）**：提供 HTTP API 服务，处理业务逻辑、数据库操作、邮件发送等
- **桌面客户端（`client/`）**：基于 PyQt6 的桌面应用，纯 UI 层，通过 HTTP 请求与后端通信，不直接访问数据库
- **Web 前端（`frontend/chat-web/`）**：基于 Vue 3 + TypeScript 的多客服工作台，用于客服人员在线处理用户咨询

### 架构优势

- ✅ **完全解耦**：客户端与后端可独立开发、部署、升级
- ✅ **安全性**：客户端不包含数据库连接、业务逻辑等敏感信息
- ✅ **可扩展性**：后端可同时服务多个客户端（桌面、Web、移动端等）
- ✅ **易维护**：前后端职责清晰，便于团队协作
- ✅ **多端支持**：桌面客户端面向用户，Web 前端面向客服，统一后端服务

---

## 功能特性

- **现代化 UI 界面**
  - 基于 `PyQt6` 实现无边框、圆角主窗口，支持自定义拖拽、蒙版遮罩等效果  
  - 左右分栏布局，包含主功能区、聊天区、公告等区域  
  - 统一图标与插画资源（见 `client/resources/icons` 与 `client/resources/images`）

- **账户系统**
  - 邮箱注册 / 登录（密码使用 `bcrypt` 加密存储）  
  - 支持默认头像与自定义头像上传 / 裁剪  
  - 自动登录、登录状态管理、本地 Token 加密存储

- **VIP 会员 & 充值体系**
  - MySQL 中维护 `users` / `user_vip` 两张表，记录会员状态、过期时间与钻石数量  
  - 支持钻石消耗开通 / 续费 VIP  
  - 提供 VIP 套餐展示、支付二维码弹窗（微信 / 支付宝），方便接入实际支付回调

- **客服聊天面板**
  - 内置客服聊天窗口，支持文本、图片、文件消息气泡展示  
  - 基于 `client/customer_service` 下的关键词匹配模块，实现 FAQ 智能回复（本地匹配）  
  - 支持 FAQ 列表、常见问题卡片、表情插入、未读消息角标等交互
  - **消息富文本支持**：Markdown 格式（加粗、斜体、代码、标题、列表、引用等）、@提及功能（@用户、@客服，自动高亮显示）、链接预览（自动识别链接并生成预览卡片）

- **系统公告**
  - `announcements` 表存储系统公告，支持在主界面滚动展示最新公告

- **Web 多客服工作台**
  - 基于 Vue 3 + TypeScript + Vite 构建的现代化 Web 前端
  - 支持多坐席同时在线、会话队列管理（我的会话 / 待接入）
  - 聊天面板支持文本消息、用户信息展示、VIP 标识、会话时长统计
  - **消息富文本支持**：Markdown 格式渲染、@提及高亮、链接预览卡片
  - 右侧信息栏展示用户基础信息、变声器环境信息、快捷回复等
  - 路由守卫实现登录鉴权，支持登录/注册/忘记密码/重置密码页面

- **邮件与安全**
  - 使用 QQ 邮箱 SMTP (`smtp.qq.com:465`) 发送验证码 / 通知邮件  
  - 本地使用对称加密保存 Token（`ENCRYPTION_KEY`），降低明文泄露风险
  - Token 签名验证由后端完成，客户端仅做格式检查

---

## 项目结构概览

```text
change_voice/
├── backend/                     # 后端服务（HTTP API）
│   ├── api_server.py            # Flask API 服务器入口
│   ├── config/                  # 配置（邮件、加密、数据库、文案等）
│   ├── customer_service/        # 客服关键词匹配与知识库（后端版本）
│   ├── database/                # MySQL 连接与线程封装
│   ├── email/                   # 邮件发送工具
│   ├── encryption/              # 加解密工具
│   ├── login/                   # 登录 / Token 生成与验证
│   ├── membership_service.py    # VIP 会员业务逻辑
│   ├── resources/               # 资源加载（后端版本）
│   ├── timer/                   # 定时任务相关
│   └── utils / validation ...   # 通用工具与校验
│       ├── rich_text_processor.py  # 富文本处理模块
│       └── link_preview.py         # 链接预览模块
│
├── client/                      # 客户端（PyQt6 UI）
│   ├── main.py                  # 程序入口，初始化 QApplication 与主窗口
│   ├── api_client.py            # HTTP API 客户端封装
│   ├── config/                  # 客户端配置（UI 文案、加密密钥等）
│   ├── customer_service/        # 客服关键词匹配（本地版本，用于聊天）
│   ├── encryption/              # 本地加密工具（Token 加密）
│   ├── login/                   # 登录状态管理、Token 存储
│   ├── resources/               # 图标与图片资源
│   ├── validation/              # 前端表单验证
│   ├── timer/                    # UI 定时器
│   ├── utils/                    # UI 工具类
│   ├── gui/                      # 界面层（PyQt6）
│   │   ├── main_window.py       # 主窗口，拼装整体 UI 与事件处理
│   │   ├── components/          # 聊天气泡、顶部栏、布局等 UI 组件
│   │   │   └── chat_rich_text.py  # 富文本处理组件
│   │   ├── handlers/            # 事件处理（聊天、窗口、会员、头像等）
│   │   └── styles/ & views/     # 样式与视图封装
│   └── modules/                  # 各类弹窗 / 对话框
│       ├── login_dialog.py      # 登录对话框
│       ├── vip_membership_dialog.py # VIP 相关对话框
│       └── dialogs/              # 支付二维码、套餐说明等弹窗
│
└── frontend/                     # Web 前端（Vue 3 + TypeScript）
    └── chat-web/                 # 多客服工作台前端
        ├── src/
        │   ├── main.ts           # 入口文件
        │   ├── App.vue           # 根组件
        │   ├── router/           # 路由配置（登录、注册、工作台等）
        │   ├── views/            # 页面组件（登录页、工作台等）
        │   ├── components/       # 通用组件（聊天面板等）
        │   ├── api/              # API 客户端封装
        │   └── utils/            # 工具函数（表单验证、富文本处理等）
        │       └── richText.ts   # 富文本处理工具
        ├── package.json          # 依赖配置
        ├── vite.config.ts        # Vite 构建配置
        └── README.md             # 前端项目说明文档
```

---

## 环境要求

### 后端
- **操作系统**：Windows / Linux / macOS  
- **Python**：建议 `Python 3.9+`  
- **数据库**：MySQL 5.7 / 8.x
- **依赖库（核心）**：
  - `Flask` - Web 框架
  - `PyMySQL` - MySQL 数据库连接
  - `bcrypt` - 密码加密
  - `cryptography` - Token 加密
  - `requests` - HTTP 客户端（用于测试）
  - `beautifulsoup4` - HTML 解析（用于链接预览）

### 桌面客户端
- **操作系统**：Windows 10 / 11（其他平台需自行测试）  
- **Python**：建议 `Python 3.9+`  
- **依赖库（核心）**：
  - `PyQt6` - GUI 框架
  - `requests` - HTTP 请求
  - `cryptography` - Token 加密

### Web 前端
- **Node.js**：建议 `Node.js 16+` 或 `18+`  
- **包管理器**：`npm` 或 `yarn`  
- **核心依赖**：
  - `Vue 3` - 前端框架
  - `TypeScript` - 类型支持
  - `Vite` - 构建工具
  - `Vue Router` - 路由管理
  - `Pinia` - 状态管理
  - `axios` - HTTP 客户端
  - `socket.io-client` - WebSocket 客户端（预留）

> 可以根据实际使用的三方库补充或维护 `requirements.txt`（后端/客户端）和 `package.json`（前端），方便一键安装依赖。

---

## 快速开始

### 1. 克隆项目

```bash
git clone <your-repo-url> change_voice
cd change_voice
```

### 2. 安装依赖

建议使用虚拟环境（如 `venv` / `conda`），然后安装依赖：

```bash
# 后端依赖
pip install Flask pymysql bcrypt cryptography requests beautifulsoup4

# 客户端依赖
pip install PyQt6 requests cryptography
```

或根据你实际维护的 `requirements.txt` 执行：

```bash
# 安装所有依赖（推荐）
pip install -r requirements.txt

# 或分别安装
pip install -r backend/requirements.txt  # 后端依赖
pip install -r client/requirements.txt   # 客户端依赖
```

### 3. 配置数据库

1. 启动本地 MySQL 服务  
2. 创建数据库（后端会自动创建，也可手动创建）：

```sql
CREATE DATABASE voice DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

3. 确认 `backend/config/database_config.py` 中的连接配置与实际一致（主机 / 端口 / 用户名 / 密码 / 数据库名）。  
4. 首次启动后端服务时会自动创建以下表：
   - `users`：用户基础信息（邮箱、用户名、密码、头像等）
   - `user_vip`：会员信息（是否 VIP、到期时间、钻石数量等）
   - `announcements`：系统公告

> 如需初始化一些测试用户 / VIP / 公告数据，可自行编写 SQL 脚本导入。

### 4. 配置邮件与加密（可选但推荐）

打开 `backend/config/config.py`：

- 修改 `email_config` 中的 `sender_email` / `sender_password` / `sender_name` 为你的发信邮箱  
- 如有安全要求，请替换 `SECRET_KEY` 与 `ENCRYPTION_KEY`
- 确保 `client/config/config.py` 中的 `ENCRYPTION_KEY` 与后端一致

### 5. 启动后端服务

在项目根目录下运行：

```bash
# 方式一：使用模块方式运行（推荐）
python -m backend.api_server

# 方式二：直接运行（需要确保在正确的路径下）
cd backend
python api_server.py
```

后端服务默认运行在 `http://127.0.0.1:8000`，你可以在浏览器访问 `http://127.0.0.1:8000/api/health` 检查服务是否正常。

### 6. 启动桌面客户端

在项目根目录下运行：

```bash
# 方式一：使用模块方式运行（推荐）
python -m client.main

# 方式二：直接运行
cd client
python main.py
```

首次运行时：

- 客户端会自动检查后端服务是否可用（`http://127.0.0.1:8000/api/health`）
- 若后端服务未启动，会弹出错误提示对话框
- 成功后将打开主窗口，可通过右上角 / 菜单等入口打开登录对话框、VIP 对话框与客服聊天面板

### 7. 启动 Web 前端（多客服工作台）

在项目根目录下运行：

```bash
cd frontend/chat-web

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev
```

启动后：

- 开发服务器默认运行在 `http://localhost:5173`
- 访问 `http://localhost:5173/login` 进入登录页
- 访问 `http://localhost:5173/workspace` 进入多客服工作台（需要登录）
- 支持路由：`/login`（登录）、`/register`（注册）、`/forgot-password`（忘记密码）、`/reset-password`（重置密码）、`/workspace`（工作台）

> **注意**：当前 Web 前端使用前端假数据进行演示，后续需要对接真实后端 API 和 WebSocket 服务。



## 客服系统简要说明

本项目内置一个基于 **关键词匹配** 的本地客服系统：

- 知识库定义在 `client/customer_service/knowledge_base.py`（客户端本地匹配）  
- 匹配逻辑封装在 `client/customer_service/keyword_matcher.py` 中，通过 `get_matcher()` 获取单例  
- 在 GUI 中，实现了用户发送消息后自动调用匹配器生成回复的流程  

扩展方式包括但不限于：

- 增加更多 FAQ 条目与关键词  
- 替换为 TF-IDF / 余弦相似度等更复杂的文本匹配算法  
- 接入在线大模型作为兜底（例如未匹配到答案时调用外部 API）
- 将匹配逻辑迁移到后端，通过 API 调用（当前为客户端本地匹配）

详情可参考模块内的 `README.md`。

---




## 开发规划 / TODO（示例）

- [x] ✅ 消息富文本功能（Markdown、@提及、链接预览）
- [ ] 接入实际的音频处理 / 变声后端服务  
- [ ] 增加多语言支持（中 / 英等）  
- [ ] 丰富会员权益展示与运营位文案  
- [ ] 优化聊天窗口的性能与消息记录持久化  

---

## 客服对话系统待完成功能

### 📊 当前系统功能概览

**已实现功能：**
- ✅ 基础关键词匹配智能回复（本地匹配）
- ✅ 桌面客户端聊天面板（文本、图片、文件消息）
- ✅ Web 客服工作台基础界面（会话列表、聊天面板）
- ✅ WebSocket 基础设施（SocketIO 已集成）
- ✅ 基础会话和消息存储（数据库表结构）
- ✅ 客服在线状态管理
- ✅ **消息富文本功能**（Markdown 格式、@提及、链接预览）
- ✅ **消息操作功能**（消息撤回、消息引用回复）
- ✅ **WebSocket 实时通信完善**（消息推送、心跳检测、自动重连、离线消息、消息队列）

**功能差距分析：**
当前系统实现了客服对话的基础框架，以下详细列出待完成的功能模块。


### 🤖 二、智能客服系统

#### 2.1 AI 助手增强
- [ ] **知识库系统**
  - 知识库管理后台（增删改查 FAQ）
  - 知识库分类与标签管理
  - 知识库搜索（全文检索、语义搜索）
  - 知识库版本管理（历史版本回滚）
  - 知识库导入导出（批量导入、格式转换）

- [ ] **智能推荐**
  - 根据用户问题智能推荐相关 FAQ
  - 根据用户历史推荐相似问题解决方案
  - 智能推荐快捷回复（根据上下文推荐）
  - 推荐相关产品/功能（基于用户咨询内容）

#### 2.2 对话流程自动化
- [ ] **对话机器人**
  - 多轮对话流程设计器（可视化流程配置）
  - 条件分支与跳转逻辑
  - 变量提取与填充（从对话中提取关键信息）
  - 外部 API 调用（调用业务系统接口）
  - 对话流程 A/B 测试

- [ ] **智能路由**
  - 根据问题类型自动分配客服（技能组路由）
  - 根据用户 VIP 等级优先分配
  - 根据客服负载自动分配（负载均衡）
  - 根据客服专业领域智能匹配

- [ ] **自动回复增强**
  - 关键词匹配算法优化（TF-IDF、余弦相似度）
  - 模糊匹配与同义词识别
  - 多答案候选与置信度评分
  - 未匹配时自动转人工客服

---

### 👥 三、人工客服工作台

#### 3.1 会话管理
- [ ] **会话创建与分配**
  - 用户发起咨询自动创建会话
  - 会话自动分配算法（轮询、负载均衡、技能匹配）
  - 会话手动分配（管理员指定客服）
  - 会话抢单机制（客服主动接单）
  - 会话超时自动分配（客服无响应时重新分配）

- [ ] **会话转接**
  - 会话转接给其他客服
  - 会话转接给技能组（自动分配给组内客服）
  - 会话转接给主管（升级处理）
  - 转接原因记录与备注
  - 转接历史追踪

- [ ] **会话状态管理**
  - 会话状态（待接入、服务中、已结束、已关闭）
  - 会话暂停/恢复功能
  - 会话超时提醒（长时间无响应提醒）
  - 会话自动结束（用户离线超时、客服结束）

- [ ] **会话标签与分类**
  - 问题类型标签（技术问题、充值问题、使用问题等）
  - 自定义标签（重要、紧急、待跟进等）
  - 标签筛选与统计
  - 标签自动推荐（基于对话内容）

#### 3.2 客服工作流
- [ ] **快捷回复管理**
  - 快捷回复库管理（增删改查）
  - 快捷回复分类（常见问题、问候语、结束语等）
  - 快捷回复变量替换（{用户名}、{VIP等级}等）
  - 快捷回复使用统计（最常用回复）


- [ ] **会话记录**
  - 会话记录导出（Excel、PDF、CSV）
  - 会话记录搜索（关键词搜索、时间范围）
  - 会话记录归档（定期归档历史记录）
  - 会话记录统计分析


---

### 📈 四、数据分析与报表

#### 4.1 会话统计分析
- [ ] **客服工作统计**
  - 客服接待会话数（日/周/月）
  - 客服平均响应时间
  - 客服平均会话时长
  - 客服解决率（首次解决率、总体解决率）
  - 客服满意度评分

- [ ] **会话质量分析**
  - 会话时长分布统计
  - 问题类型分布统计
  - 会话高峰时段分析

- [ ] **用户行为分析**
  - 用户咨询频率分析
  - 用户问题偏好分析
  - VIP 用户咨询特征分析

#### 4.2 数据可视化
- [ ] **实时数据看板**
  - 实时在线客服数
  - 实时待接入会话数
  - 实时会话处理速度
  - 实时用户满意度

- [ ] **报表系统**
  - 日报、周报、月报自动生成
  - 自定义报表（自定义指标、时间范围）
  - 报表导出与分享
  - 报表定时发送（邮件推送）

- [ ] **数据大屏**
  - 客服工作大屏（大屏展示关键指标）
  - 实时监控大屏（异常预警）
  - 数据对比分析（同比、环比）

---

### 🎯 五、用户侧功能增强

#### 5.1 用户体验优化
- [ ] **会话历史**
  - 用户查看历史会话记录
  - 会话记录搜索功能
  - 重要会话收藏
  - 会话评价与反馈

- [ ] **智能助手**
  - 用户端智能助手（7x24 小时自动回复）
  - 常见问题快速入口
  - 问题分类引导（帮助用户快速定位问题）
  - 自助服务（用户自行解决问题）

- [ ] **满意度评价**
  - 会话结束后满意度评价（1-5星）
  - 评价标签（响应快、解决及时、态度好等）
  - 评价反馈收集与分析
  - 评价结果展示（客服评分展示）

#### 5.2 通知与提醒
- [ ] **消息通知**
  - 桌面通知（新消息桌面弹窗）
  - 声音提醒（新消息声音提示）
  - 浏览器通知（Web 端通知）
  - 通知设置（免打扰时段、通知方式）

- [ ] **会话提醒**
  - 客服回复提醒
  - 会话超时提醒（长时间无响应）
  - 重要消息提醒（客服标记重要消息）
  - 系统公告推送

---

### 🔧 六、系统管理与配置

#### 6.1 客服管理
- [ ] **客服账号管理**
  - 客服账号创建、编辑、删除
  - 客服角色权限管理（普通客服、主管、管理员）
  - 客服技能组管理（技术组、销售组、售后组等）
  - 客服工作时段设置（排班管理）


#### 6.2 系统配置
- [ ] **业务规则配置**
  - 会话超时时间配置
  - 自动分配规则配置
  - 智能路由规则配置
  - 消息撤回时间限制配置
  - 文件上传大小限制配置


#### 6.3 安全与合规
- [ ] **数据安全**
  - 消息加密传输（TLS/SSL）
  - 敏感信息脱敏（手机号、邮箱等）
  - 数据备份与恢复
  - 数据访问日志（审计日志）

- [ ] **合规管理**
  - 会话记录保存期限管理
  - 用户隐私保护（GDPR 合规）
  - 内容审核（敏感词过滤）
  - 投诉处理流程



## 许可证

根据你的实际使用场景选择合适的开源协议（例如 MIT / Apache-2.0 / GPL 等），  
并在仓库中添加 `LICENSE` 文件。当前示例未附带具体许可证，请在正式开源前补充。